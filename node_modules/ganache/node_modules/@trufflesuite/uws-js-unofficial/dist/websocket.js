"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.WebSocket = void 0;
const TOO_BIG_MESSAGE = Buffer.from("Received too big message", "utf8");
/**
 * Converts a buffer to an `ArrayBuffer`.
 *
 * @param buf The buffer to convert
 * @return Converted buffer
 * @public
 */
function toArrayBuffer(buf) {
    if (buf.byteLength === buf.buffer.byteLength) {
        return buf.buffer;
    }
    return buf.buffer.slice(buf.byteOffset, buf.byteOffset + buf.byteLength);
}
class WebSocket {
    constructor(internalWs) {
        this._fragBinState = false;
        this.internalWs = internalWs;
        // `nodebuffer` is already the default, but I just wanted to be explicit
        // here because when `nodebuffer` is the binaryType the `message` event's
        // data type is guaranteed to be a `Buffer`. We don't need to check for
        // different types of data.
        // I mention all this because if `arraybuffer` or `fragment` is used for the
        // binaryType the `"message"` event's `data` may end up being
        // `ArrayBuffer | Buffer`, or `Buffer[] | Buffer`, respectively.
        internalWs.binaryType = "nodebuffer";
    }
    initialize(behavior) {
        this.internalWs.removeAllListeners();
        if (typeof behavior.open === "function") {
            behavior.open(this);
        }
        this.internalWs.on("error", (error) => {
            // if max payload size is exceed we want to match uWS error handling.
            // It propagates the error with code `1006` and message "Received too big
            // message".
            if (error.message === "Max payload size exceeded") {
                this.internalWs._closeCode = 1006;
                this.internalWs._closeMessage = TOO_BIG_MESSAGE;
            }
            else {
                throw error;
            }
        });
        this.internalWs.on("message", (message, isBinary) => {
            if (typeof behavior.message === "function") {
                behavior.message(this, toArrayBuffer(message), isBinary);
            }
        });
        // TODO: there is no "drain" event for `ws`
        // this currently isn't used by ganache so moving along
        this.internalWs.on("close", (code, reason) => {
            if (typeof behavior.close === "function") {
                const buf = reason ? toArrayBuffer(reason) : new ArrayBuffer(0);
                behavior.close(this, code, buf);
            }
            this.internalWs.removeAllListeners(); // may be redundant
        });
        this.internalWs.on("ping", (data) => {
            if (typeof behavior.ping === "function") {
                behavior.ping(this, data);
            }
        });
        this.internalWs.on("pong", (data) => {
            if (typeof behavior.pong === "function") {
                behavior.pong(this, data);
            }
        });
    }
    send(message, isBinary, compress) {
        this.internalWs.send(message, {
            binary: isBinary,
            compress,
        });
        return 1;
    }
    sendFirstFragment(message, isBinary, compress = false) {
        this._fragBinState = isBinary;
        this.internalWs.send(message, { fin: false, binary: isBinary, compress });
        return true;
    }
    sendFragment(message, compress = false) {
        this.internalWs.send(message, { fin: false, binary: this._fragBinState, compress });
        return true;
    }
    sendLastFragment(message, compress = false) {
        this.internalWs.send(message, { fin: true, binary: this._fragBinState, compress });
        return true;
    }
    getBufferedAmount() {
        return this.internalWs.bufferedAmount;
    }
    end(code, shortMessage) {
        this.internalWs.close(code, shortMessage.toString());
        return this;
    }
    close() {
        this.internalWs.terminate();
        this.internalWs.removeAllListeners(); // may be redundant
        return this;
    }
    ping(message) {
        this.internalWs.ping(message);
        return 1;
    }
    // TODO this isn't currently necessary
    // so we're not implementing it yet
    subscribe(topic) {
        return false;
    }
    // TODO this isn't currently necessary
    // so we're not implementing it yet
    isSubscribed() {
        return false;
    }
    // TODO this isn't currently necessary
    // so we're not implementing it yet
    getTopics() {
        return [];
    }
    // TODO this isn't currently necessary
    // so we're not implementing it yet
    unsubscribe(topic) {
        return false;
    }
    // TODO this isn't currently necessary
    // so we're not implementing it yet
    unsubscribeAll() {
        return;
    }
    // TODO this isn't currently necessary
    // so we're not implementing it yet
    publish(topic, message, isBinary, compress) {
        return false;
    }
    cork(cb) {
        cb();
        return this;
    }
    // TODO this isn't currently necessary
    // so we're not implementing it yet
    getRemoteAddress() {
        return new ArrayBuffer(0);
    }
    getRemoteAddressAsText() {
        const url = this.internalWs.url;
        const buf = new ArrayBuffer(url.length);
        const bufView = new Uint8Array(buf);
        for (let i = 0; i < url.length; i++) {
            bufView[i] = url.charCodeAt(i);
        }
        return buf;
    }
}
exports.WebSocket = WebSocket;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2Vic29ja2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2ZhbGxiYWNrL3dlYnNvY2tldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFPQSxNQUFNLGVBQWUsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLDBCQUEwQixFQUFFLE1BQU0sQ0FBQyxDQUFDO0FBRXhFOzs7Ozs7R0FNRztBQUNILFNBQVMsYUFBYSxDQUFDLEdBQVc7SUFDaEMsSUFBSSxHQUFHLENBQUMsVUFBVSxLQUFLLEdBQUcsQ0FBQyxNQUFNLENBQUMsVUFBVSxFQUFFO1FBQzVDLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQztLQUNuQjtJQUVELE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxHQUFHLENBQUMsVUFBVSxHQUFHLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUMzRSxDQUFDO0FBRUQsTUFBYSxTQUFTO0lBR3BCLFlBQVksVUFBNkI7UUFzRWpDLGtCQUFhLEdBQVksS0FBSyxDQUFDO1FBckVyQyxJQUFJLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQztRQUM3Qix3RUFBd0U7UUFDeEUseUVBQXlFO1FBQ3pFLHVFQUF1RTtRQUN2RSwyQkFBMkI7UUFDM0IsNEVBQTRFO1FBQzVFLDZEQUE2RDtRQUM3RCxnRUFBZ0U7UUFDaEUsVUFBVSxDQUFDLFVBQVUsR0FBRyxZQUFZLENBQUM7SUFDdkMsQ0FBQztJQUVELFVBQVUsQ0FBQyxRQUEyQjtRQUNwQyxJQUFJLENBQUMsVUFBVSxDQUFDLGtCQUFrQixFQUFFLENBQUM7UUFFckMsSUFBSSxPQUFPLFFBQVEsQ0FBQyxJQUFJLEtBQUssVUFBVSxFQUFFO1lBQ3ZDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDckI7UUFFRCxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxLQUFLLEVBQUUsRUFBRTtZ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